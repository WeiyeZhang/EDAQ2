---
title: "EDA For Question2"
author: "U1813544"
geometry: margin=2cm
output:
  html_document: default
  pdf_document: default
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE,results='hide',message=FALSE}
library(rio)
library(lubridate)
library(dplyr)
library(ggplot2)
library(stringr)
library(gridExtra)
library(plyr)
library(kableExtra)

CovidData<- import("tidycovid19.csv", setclass="tibble")
CovidData$date = as.Date(parse_date_time(CovidData$date,orders=c("y","ym","ymd")))
```

```{r,echo=FALSE,results='hide',message=FALSE}
firstdiff <- function(x) {
  shifted <- c(0,x[1:(length(x)-1)])
  result = x-shifted
  which_negative = which(result<0)
  result[which_negative] = NA
  return(result)
}

CovidData <- mutate(CovidData, daily_confirmed = firstdiff(confirmed))
CovidData <- mutate(CovidData, daily_deaths = firstdiff(deaths))
```

Selecting two countries in North America, Canada and Mexico, and two countries in South America: Argentina and Brazil. We choose the baseline date as 2020-02-06 and the period ends at 2020-09-23.

```{r,echo=FALSE,results='hide',message=FALSE}
BrazilData <- {CovidData %>% 
    filter ((str_detect(country, "Brazil")) & (date > as.Date("2020-02-06")))}
ArgentinaData <- {CovidData %>% 
    filter ((str_detect(country, "Argentina")) & (date > as.Date("2020-02-06")))}
CanadaData <- {CovidData %>% 
    filter ((str_detect(country, "Canada")) & (date > as.Date("2020-02-06")))}
MexicoData <- {CovidData %>% 
    filter ((str_detect(country, "Mexico")) & (date > as.Date("2020-02-06")))}
```

Then we extract all the variables from our variables list to our data frame.

```{r,echo=FALSE,results='hide',message=FALSE}
Brazil <- {BrazilData%>% 
    filter(country == "Brazil") %>%
    select(country,date, daily_confirmed,daily_deaths, soc_dist,mov_rest,pub_health,lockdown,gov_soc_econ,apple_mtr_driving,gcmr_retail_recreation,gcmr_workplaces,gcmr_residential, gcmr_workplaces,gtrends_score,gcmr_grocery_pharmacy) }

Mexico <-{MexicoData%>% 
    select(country,date, daily_confirmed,daily_deaths, soc_dist,mov_rest,pub_health,lockdown,gov_soc_econ,apple_mtr_driving,gcmr_retail_recreation,gcmr_workplaces,gcmr_residential, gcmr_workplaces,gtrends_score,gcmr_grocery_pharmacy) }

Canada<-{CanadaData %>% 
    select(country,date, daily_confirmed,daily_deaths, soc_dist,mov_rest,pub_health,lockdown,gov_soc_econ,apple_mtr_driving,gcmr_retail_recreation,gcmr_workplaces,gcmr_residential, gcmr_workplaces,gtrends_score, gcmr_grocery_pharmacy) }

Argentina<-{ArgentinaData %>% 
    select(country,date, daily_confirmed,daily_deaths, soc_dist,mov_rest,pub_health,lockdown,gov_soc_econ,apple_mtr_driving,gcmr_retail_recreation,gcmr_workplaces,gcmr_residential, gcmr_workplaces,gtrends_score,gcmr_grocery_pharmacy) }

country<-c("Brazil","Mexico","Canada","Argentina")
Americadata<-rbind.fill(Argentina,Brazil,Canada,Mexico)
```

### Overview

#### Let's have a general overview on four chosen coutries.

##### Daily confirmed cases in the whole period in different countries.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Americaconfirmed<-{Americadata%>%ggplot(aes(x=date,y=daily_confirmed,color=country))}+labs(x="Date",y="Daily confirmed cases",title = "Daily confirmed in four chosen countries.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")

Americadeaths<-{Americadata%>%ggplot(aes(x=date,y=daily_deaths,color=country))}+labs(x="Date",y="Daily deaths cases",title = "Daily deaths in four chosen countries.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")

grid.arrange(Americaconfirmed,Americadeaths)
```


#### Brazil

##### 1.Daily confirmed cases in Brazil climbed up to 70,000 at the end of July and decreased until the beginning of November.Recently the number of daily confirmed cases has tendency to increase.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Bdaily.confirmed<-{BrazilData%>%ggplot(aes(x=date,y=daily_confirmed))}+labs(x="Date",y="Daily confirmed cases",title = "Daily confirmed case in Brazil.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")+geom_smooth(method = "loess")#local regression fitting

Bdaily.deaths<-{BrazilData%>%ggplot(aes(x=date,y=daily_deaths))}+labs(x="Date",y="Daily deaths in Brazil",title = "Daily deaths in Brazil.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")+geom_smooth(method = "loess")
  
grid.arrange(Bdaily.confirmed,Bdaily.deaths)
```

##### 2.Relationship between Number of daily confirmed cases and the frequency that people visit retail and recreation places in Brazil.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Brazilconfirm.retail<-ggplot(Brazil, aes(x=daily_confirmed, y=gcmr_retail_recreation)) +  geom_point()+labs(x="Number of daily confirmed cases",y="Activity in recreation (% change from baseline)",title ="Relationship between daily confirmed cases and the frequency that people visit retail and recreation places",subtitle =" Drawn from Google Community Mobility Reports")+geom_smooth(method = "loess")
print(Brazilconfirm.retail)
 
Brazilconfirm.gro<- ggplot(Brazil, aes(x=daily_confirmed, y=Brazil$gcmr_grocery_pharmacy)) +  geom_point()+labs(x="Number of daily confirmed cases",y="Activity in recreation (% change from baseline)",title ="Daily confirmed cases and activity change in grocery and pharmacy places.",subtitle =" Drawn from Google Community Mobility Reports")+geom_smooth(method = "loess")
print(Brazilconfirm.gro)

Brazilconfirm.work<- ggplot(Brazil, aes(x=daily_confirmed, y=Brazil$gcmr_workplaces)) +  geom_point()+labs(x="Number of daily confirmed cases",y="Activity in recreation (% change from baseline)",title ="Daily confirmed cases and activity change in workplaces.",subtitle =" Drawn from Google Community Mobility Reports")+geom_smooth(method = "loess")
print(Brazilconfirm.work)
  
```

#### Canada

#####1.There are two phases in Canada so we divide into phase one and phase two. Phase one started at beginning of Feburary and reached 2,000 cases to one-month period with less than 1,000 daily confirmed cases. Second phase has started around August and it is noticeable that second wave reaches much higher daily confirmed cases. 

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Cdaily.confirmed<-{CanadaData%>%ggplot(aes(x=date,y=daily_confirmed))}+labs(x="Date",y="Daily confirmed cases",title = "Daily confirmed in Canada.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")+geom_vline(xintercept = as.numeric(ymd("2020-07-15")), linetype="dashed", 
                color = "steelblue",size=1)+geom_vline(xintercept = as.numeric(ymd("2020-04-30")), linetype="dashed", 
                color = "steelblue",size=1)+geom_smooth(method = "loess")

Cdaily.deaths<-{BrazilData%>%ggplot(aes(x=date,y=daily_deaths))}+labs(x="Date",y="Daily deaths",title = "Daily deaths in Canada.")+geom_point()+scale_color_brewer(palette="Set1")+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")+geom_vline(xintercept = as.numeric(ymd("2020-07-15")), linetype="dashed", 
                color = "steelblue",size=1)+geom_smooth(method = "loess")+geom_vline(xintercept = as.numeric(ymd("2020-04-30")), linetype="dashed", 
                color = "steelblue",size=1)
  
grid.arrange(Cdaily.confirmed,Cdaily.deaths)
```

#####2. For the first wave and second wave, the graph below shows relationship between number of daily confirmed cases and the frequency that people visit retail and recreation places in Canada respectively.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Canadaphase1<-CanadaData%>% filter(date < as.Date("2020-07-16"))
Canadaphase2<-CanadaData%>% filter(date> as.Date("2020-07-15"))

Canadaphase1.retail<-ggplot(Canadaphase1, aes(x=Canadaphase1$daily_confirmed, y=Canadaphase1$gcmr_retail_recreation)) +  geom_point(colour="red")+labs(x="Number of daily confirmed cases",y="Activity in recreation (% change from baseline)",title ="1st wave: Number of daily confirmed cases and activity change in retail and recreation places.",subtitle ="Drawn from Google Community Mobility Reports")+geom_smooth(method="loess",se=FALSE)

Canadaphase2.retail<-ggplot(Canadaphase2, aes(x=Canadaphase2$daily_confirmed, y=Canadaphase2$gcmr_retail_recreation)) +  geom_point(colour="orange")+labs(x="Number of daily confirmed cases",y="Activity in recreation (% change from baseline)",title ="2nd wave: Number of public health measures and activity change in retail recreation places",subtitle =" Drawn from Google Community Mobility Reports")+geom_smooth(method="loess",se=FALSE)

grid.arrange(Canadaphase1.retail,Canadaphase2.retail)
```
##### 3.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Canadaphase1.work<-ggplot(Canadaphase1, aes(x=Canadaphase1$daily_confirmed, y=Canadaphase1$gcmr_workplaces)) +  geom_point(colour="red")+labs(x="Number of daily confirmed cases",y="Activity in workplaces (% change from baseline)",title ="1st wave: Number of daily confirmed cases and activity change in workplaces.",subtitle ="Drawn from Google Community Mobility Reports")+geom_smooth(method="loess",se=FALSE)

Canadaphase2.work<-ggplot(Canadaphase2, aes(x=Canadaphase2$daily_confirmed, y=Canadaphase2$gcmr_workplaces)) +  geom_point(colour="orange")+labs(x="Number of daily confirmed cases",y="Activity in workplaces (% change from baseline)",title ="2nd wave: Number of public health measures and activity change in workplaces",subtitle =" Drawn from Google Community Mobility Reports")+geom_smooth(method="loess",se=FALSE)

grid.arrange(Canadaphase1.work,Canadaphase2.work)
```



### Condiser other datasets.

##### \nWe now have a look into Government Response Index Tracker collected by Oxford University, the interpretation of the variables is [here](https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/codebook.md)

The variables chosen shows below with definition and coding, each measured in ordinal scale.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
varname<-c("*C1_School closing","*C2_Workplace closing","*C4_Restrictions on gatherings","*C6_Stay at home requirements","*C7_Restrictions on internal movement","*C8_International travel controls")
vardef<-c("Record closings of schools and universities","Record closings of workplaces","Record limits on private gatherings","Record orders to 'shelter-in-place' and otherwise confine to the home","Record restrictions on internal movement between cities/regions","Record restrictions on international travel. 
          Note: this records policy for foreign travellers, not citizens")

c1<-c("0 - no measures,   1 - recommend closing or all schools open with alterations resulting in significant differences compared to non-Covid-19 operations,   2 - require closing (only some levels or categories, eg just high school, or just public schools,   3 - require closing all levels \nBlank - no data")

c2<-c("0 - no measures,
1 - recommend closing (or recommend work from home),
2 - require closing (or work from home) for some sectors or categories of workers,
3 - require closing (or work from home) for all-but-essential workplaces (eg grocery stores, doctors),
Blank - no data")

c4<-c("	0 - no restrictions,
1 - restrictions on very large gatherings (the limit is above 1000 people),  
2 - restrictions on gatherings between 101-1000 people,  
3 - restrictions on gatherings between 11-100 people,  
4 - restrictions on gatherings of 10 people or less,
Blank - no data")

c6=c("	0 - no measures,
1 - recommend not leaving house,
2 - require not leaving house with exceptions for daily exercise, grocery shopping, and 'essential' trips,
3 - require not leaving house with minimal exceptions (eg allowed to leave once a week, or only one person can leave at a time, etc),
Blank - no data")

c7=c("0 - no measures ,
1 - recommend not to travel between regions/cities ,  
2 - internal movement restrictions in place ,
Blank - no data")

c8=("0 - no restrictions ,  
1 - screening arrivals ,  
2 - quarantine arrivals from some or all regions ,  
3 - ban arrivals from some regions ,  
4 - ban on all regions or total border closure ,  
Blank - no data")
varcoding=c(c1,c2,c4,c6,c7,c8)
data.frame(varname, vardef, varcoding) %>%
  kbl( col.names = c("Variable name", "Variable definition", "Variable coding")) %>%
   kable_styling()
```

```{r,echo=FALSE,results='hide',message=FALSE}
Brazil1<- {Brazil %>% 
    filter ( date <as.Date("2020-11-10") )}
Argentina1 <- {Argentina%>% 
    filter (date <as.Date("2020-11-10"))}
Canada1 <- {Canada%>% 
    filter ( date <as.Date("2020-11-10"))}
Mexico1 <- {Mexico %>% 
    filter (date <as.Date("2020-11-10"))}
```

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
GovResptracker<- import("OxCGRT_latest.csv",setclass = "tibble")

BrazilGov <- {GovResptracker %>% 
    filter((str_detect(CountryName,"Brazil")) & (Date > as.Date("2020-02-06") & Date <as.Date("2020-11-10")) & str_detect(Jurisdiction,"NAT_TOTAL"))}
BrazilGov$Date = as.Date(parse_date_time(BrazilGov$Date,orders=c("y","ym","ymd")))

CanadaGov <- {GovResptracker %>% 
    filter((str_detect(CountryName,"Canada")) & (Date > as.Date("2020-02-06") & Date <as.Date("2020-11-10")))}
CanadaGov$Date = as.Date(parse_date_time(CanadaGov$Date,orders=c("y","ym","ymd")))


ArgentinaGov<-{GovResptracker %>% 
    filter((str_detect(CountryName,"Argentina")) & (Date > as.Date("2020-02-06") & Date <as.Date("2020-11-10")))}
ArgentinaGov$Date = as.Date(parse_date_time(ArgentinaGov$Date,orders=c("y","ym","ymd")))

MexicoGov<-{GovResptracker %>% 
    filter((str_detect(CountryName,"Mexico")) & (Date > as.Date("2020-02-06") & Date <as.Date("2020-11-10")))}
MexicoGov$Date = as.Date(parse_date_time(MexicoGov$Date,orders=c("y","ym","ymd")))

AmericaGov<-rbind(BrazilGov,CanadaGov,ArgentinaGov,MexicoGov)

ItalyGov<- {GovResptracker%>%
        filter((str_detect(CountryName,"Italy")) & (Date > as.Date("2020-02-06") & Date <as.Date("2020-11-10")))}
ItalyGov$Date = as.Date(parse_date_time(ItalyGov$Date,orders=c("y","ym","ymd")))
```

## Brazil.

#### 1.Activity change in retail and recreation places related to level of staying at home requirements.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}

BrazilGov$`C6_Stay at home requirements` <- as.factor(BrazilGov$`C6_Stay at home requirements`)
BrazilGov$`C4_Restrictions on gatherings`<-as.factor(BrazilGov$`C4_Restrictions on gatherings`)
BrazilGov$`C2_Workplace closing`<-as.factor(BrazilGov$`C2_Workplace closing`)


Bretail.home.date<-{BrazilGov%>%ggplot(aes(x=Date,y=Brazil1$gcmr_retail_recreation,color=`C6_Stay at home requirements`))}+labs(x="Date",y="Activity Change % from baseline",title = "A sharp decrease around 70% occured at the start of pandemic and slowly recovered.")+geom_point()+scale_x_date(date_breaks = "3 week", date_labels = "%d/%m")

Bretail.home<-{BrazilGov %>% ggplot(aes(y=`C6_Stay at home requirements`,x=Brazil1$gcmr_retail_recreation))}+geom_violin(aes(fill=BrazilGov$`C6_Stay at home requirements`))+labs(y="Level of staying at home requirements", x="Activity change % from baseline",title = "Distribution of activity change in retail and recreation places of at four level of requirements")

grid.arrange(Bretail.home.date,Bretail.home)
```

#### 2.Activity change in frequency that people visiting the residencial places, given level of requirements on staying at home.

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Bresi.home <- {BrazilGov %>% ggplot(aes(x=Date,y=Brazil1$gcmr_residential,color=`C6_Stay at home requirements`))}+geom_point()+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")+labs(y="Activity in residential places (% change from baseline)",title = "Change in activity  in residential places with requirements on staying at home.")

covBresi.home <- {BrazilGov %>% ggplot(aes(x=Brazil1$gcmr_residential,y=BrazilGov$`C6_Stay at home requirements`))}+labs(y="Level of requirements on staying at home",x="Activity change in residential places",title = "Covariation between level of workplaces closing and requirements  at staying at home.")+geom_violin(aes(fill=BrazilGov$`C6_Stay at home requirements`))

grid.arrange(Bresi.home,covBresi.home)

```
\n
####  By the plot below, we observe that public reaction after different level of closing workplaces. The frequency of visiting workplaces sharply decreased after government required closing(or work from home) for all-but-essential workplaces (eg grocery stores, doctors). But in the mid-late people tend to visiting workplaces under level 3 closing policy. 

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}

Bworkplaces.closing<-{BrazilGov %>% ggplot(aes(x=Date,y=Brazil1$gcmr_workplaces,color=`C2_Workplace closing`))}+geom_point()+labs(x="date", y="Activity in grocery and pharmacy places (% change from baseline)",title = "Activity change in workplaces",subtitle = "Observing level of workplaces closing.")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

covBworkplaces.closing<- {BrazilGov %>% ggplot(aes(x=Brazil1$gcmr_workplaces,y=BrazilGov$`C2_Workplace closing`))}+labs(y="Level of requirements on staying at home",x="Activity change in workplaces",title = "Covariation between level of workplaces closing and requirements  at staying at home.")+geom_violin(aes(fill=BrazilGov$`C2_Workplace closing`))

grid.arrange(Bworkplaces.closing,covBworkplaces.closing)
```


## Canada

#### 1. Staying at home requirements and retail and recreation places.
```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}

CanadaGov$`C6_Stay at home requirements` <- as.factor(CanadaGov$`C6_Stay at home requirements`)
CanadaGov$`C4_Restrictions on gatherings`<-as.factor(CanadaGov$`C4_Restrictions on gatherings`)
CanadaGov$`C2_Workplace closing`<-as.factor(CanadaGov$`C2_Workplace closing`)
govCanadaphase2<-filter(Canadaphase2,date <as.Date("2020-11-10"))


Cretail.home1<-{CanadaGov %>%
    filter(Date < as.Date("2020-07-16"))%>%
    ggplot(aes(x=Date,y=Canadaphase1$gcmr_retail_recreation,color=`C6_Stay at home requirements`))}+geom_point()+labs(x="date", y="Activity change in retail and recreation places",title = "Phase 1: Sharp decrease of 60% in retail and recreation places in twenty days.",subtitle = "With level of staying at home requirements")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

Cretail.home2<-{CanadaGov %>%
    filter(Date > as.Date("2020-07-15"))%>%
    ggplot(aes(x=Date,y=govCanadaphase2$gcmr_retail_recreation,color=`C6_Stay at home requirements`))}+geom_point()+labs(x="date", y="Activity change in recreation",title = "Phase 2: A dip off again in activity change in retail and recreation places.")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

grid.arrange(Cretail.home1,Cretail.home2)

```

#### 2. Staying at home requirements & Residential activities.
```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Cresidential.home1<-{CanadaGov %>%
    filter(Date < as.Date("2020-07-16"))%>%
    ggplot(aes(x=Date,y=Canadaphase1$gcmr_residential,color=`C6_Stay at home requirements`))}+geom_point()+labs(x="date", y="Activity change in resiential places",title = "Phase 1: A climb of 30% in residential places activity, and people tend to visiting ouside.",subtitle = "With level of staying at home requirements")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

Cresidential.home2<-{CanadaGov %>%
    filter(Date > as.Date("2020-07-15"))%>%
    ggplot(aes(x=Date,y=govCanadaphase2$gcmr_residential,color=`C6_Stay at home requirements`))}+geom_point()+labs(x="date", y="Activity change in residential places",title = "Phase 2: A steady trend in activity change in residential places.")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

grid.arrange(Cresidential.home1,Cresidential.home2)

covCresi.home1 <- {CanadaGov %>% ggplot(aes(x=Canada1$gcmr_residential,y=`C6_Stay at home requirements`))}+labs(y="Level of requirements on staying at home",x="Activity change in residential places",title = "Phase 1: Covariation between level of workplaces closing and requirements  at staying at home.")+geom_violin(aes(fill=CanadaGov$`C6_Stay at home requirements`))

print(covCresi.home1)
```

\n

#### 3. workplaces closing & freuqency visiting workplaces

```{r,echo=FALSE,results='hide',message=FALSE,warning=FALSE}
Cwork.closing1<-{CanadaGov %>%
    filter(Date < as.Date("2020-07-16"))%>%
    ggplot(aes(x=Date,y=Canadaphase1$gcmr_workplaces,color=`C2_Workplace closing`))}+geom_point()+labs(x="date", y="Activity change in workplaces",title = "Phase 1: Recovering in activities in workplaces.",subtitle = "With level of staying at home requirements")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

Cwork.closing2<-{CanadaGov %>%
    filter(Date > as.Date("2020-07-15"))%>%
    ggplot(aes(x=Date,y=govCanadaphase2$gcmr_workplaces,color=`C2_Workplace closing`))}+geom_point()+labs(x="date", y="Activity change in  workplaces",title = "Phase 2: A steady trend in activity workplaces.")+scale_x_date(date_breaks = "3 weeks", date_labels = "%d/%m")

grid.arrange(Cwork.closing1,Cwork.closing2)

covCwork.closing1 <- {CanadaGov %>% ggplot(aes(x=Canada1$gcmr_workplaces,y=`C2_Workplace closing`))}+labs(y="Level of requirements on closing workplaces",x="Activity change in  workplaces",title = "Phase 1: Covariation between level of workplaces closing and requirements  at staying at home.")+geom_violin(aes(fill=CanadaGov$`C2_Workplace closing`))

print(covCwork.closing1)
```
